<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Saint Latte — Programa de Lealtad</title>
  <link rel="stylesheet" href="styles.css">

  <style>
    /* Estilos del aviso de privacidad */
    .privacy-link {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 0.9rem;
      color: #7D7461;
      cursor: pointer;
      background: rgba(255, 249, 244, 0.9);
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #E5D9C5;
      transition: all 0.3s;
      z-index: 10;
    }
    .privacy-link:hover {
      color: #2D2A26;
      background: #FFF3E0;
    }

    /* Modal de privacidad */
    .privacy-modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(45, 42, 38, 0.6);
      justify-content: center;
      align-items: center;
    }

    .privacy-content {
      background: #FFF9F4;
      color: #2D2A26;
      padding: 25px;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      text-align: left;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .privacy-content h2 {
      margin-top: 0;
      color: #556B2F;
    }

    .close-btn {
      float: right;
      font-weight: bold;
      cursor: pointer;
      color: #7D7461;
    }

    .close-btn:hover {
      color: #2D2A26;
    }

    /* Overlay de carga (nutria girando) */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
    }

    #loadingOverlay img {
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/logo.png" alt="Saint Latte" class="logo">
    <h1>SAINT LATTE REWARDS</h1>

    <!-- Registro -->
    <div class="form">
      <h3>Registro</h3>
      <input type="text" id="name" placeholder="Tu nombre completo">
      <input type="tel" id="phone" placeholder="Número telefónico">
      <button id="registerBtn">Registrarme</button>

      <hr>

      <!-- Login -->
      <h3>Ya estoy registrado</h3>
      <input type="tel" id="loginPhone" placeholder="Ingresa tu número">
      <input type="password" id="loginPassword" placeholder="Ingresa tu contraseña">
      <button id="loginBtn">Ingresar</button>

      <p class="small">
        Al registrarte recibirás un código único, un QR y tu contraseña para ingresar al dashboard.
      </p>
    </div>
  </div>

  <!-- Overlay de carga -->
  <div id="loadingOverlay">
    <img src="assets/otter.png" alt="Nutria girando">
    <p>Procesando, por favor espera...</p>
  </div>

  <!-- Enlace al aviso -->
  <div class="privacy-link" onclick="openPrivacy()">Aviso de privacidad</div>

  <!-- Modal -->
  <div class="privacy-modal" id="privacyModal">
    <div class="privacy-content">
      <span class="close-btn" onclick="closePrivacy()">&times;</span>
      <h2>Aviso de Privacidad</h2>
      <p>
        En Saint Latte, la protección de tus datos personales es una prioridad.  
        La información que proporcionas al registrarte (nombre y número telefónico) se utiliza exclusivamente
        para administrar tu participación en el programa de lealtad <strong>Saint Latte Rewards</strong>.
      </p>
      <p>
        No compartimos, vendemos ni transferimos tu información a terceros.  
        Puedes solicitar la eliminación de tus datos en cualquier momento contactándonos directamente en la cafetería.
      </p>
      <p>Última actualización: Octubre 2025.</p>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby3ZOGhDlhLmyI8nhrq5KVBkJye-Q_9c6k4x1giUEnapr9llWv4j-adzVVazGJqRdY6aA/exec";
    const loadingOverlay = document.getElementById("loadingOverlay");
    const registerBtn = document.getElementById("registerBtn");
    const loginBtn = document.getElementById("loginBtn");

    function showLoading() {
      loadingOverlay.style.display = "flex";
    }

    function hideLoading() {
      loadingOverlay.style.display = "none";
    }

    // Bloquear doble clic
    function disableButton(btn) {
      btn.disabled = true;
      btn.style.opacity = "0.6";
      btn.style.cursor = "not-allowed";
    }

    function enableButton(btn) {
      btn.disabled = false;
      btn.style.opacity = "1";
      btn.style.cursor = "pointer";
    }

    // Registro
    async function register() {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      if (!name || !phone) return alert("Completa todos los campos.");

      disableButton(registerBtn);
      showLoading();

      try {
        const res = await fetch(`${SCRIPT_URL}?action=register&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}`);
        const data = await res.json();

        hideLoading();
        enableButton(registerBtn);

        if (data.status === "ok") {
          document.body.innerHTML = `
          <div class="container">
            <img src="assets/logo.png" class="logo" alt="Saint Latte">
            <h2>¡Gracias por registrarte, ${name}!</h2>
            <p>Tu código único:</p>
            <h3>${data.code}</h3>
            <img src="${data.qrUrl}" alt="QR de cliente" class="qr-card">
            <p>Tu contraseña para ingresar al dashboard:</p>
            <h3>${data.password}</h3>
            <p class="small">Guarda este QR y tu contraseña. Los necesitarás para iniciar sesión.</p>
            <p><a href="index.html">Volver al inicio</a></p>
          </div>`;
        } else {
          alert(data);
        }
      } catch (e) {
        hideLoading();
        enableButton(registerBtn);
        alert("Error al registrar. Intenta nuevamente.");
        console.error(e);
      }
    }

    // Login
    async function login() {
      const phone = document.getElementById("loginPhone").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      if (!phone || !password) return alert("Ingresa tu número y contraseña.");

      disableButton(loginBtn);
      showLoading();

      try {
        const res = await fetch(`${SCRIPT_URL}?action=login&phone=${encodeURIComponent(phone)}&password=${encodeURIComponent(password)}`);
        const text = await res.text();

        hideLoading();
        enableButton(loginBtn);

        try {
          const data = JSON.parse(text);
          if (data.name) {
            localStorage.setItem("user", JSON.stringify(data));
            window.location.href = "dashboard.html";
          } else {
            alert("Teléfono o contraseña incorrectos.");
          }
        } catch (err) {
          alert(text);
        }
      } catch (e) {
        hideLoading();
        enableButton(loginBtn);
        alert("Error contactando el servidor.");
        console.error(e);
      }
    }

    // Eventos
    registerBtn.addEventListener("click", register);
    loginBtn.addEventListener("click", login);

    // Aviso de privacidad
    function openPrivacy() {
      document.getElementById("privacyModal").style.display = "flex";
    }
    function closePrivacy() {
      document.getElementById("privacyModal").style.display = "none";
    }
  </script>
</body>
</html>
