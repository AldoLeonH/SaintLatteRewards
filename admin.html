<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saint Latte — Panel Admin</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    /* Overlay de carga con nutria girando */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 99999;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
    }

    #loadingOverlay img {
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Panel Administrador</h1>

    <div class="scanner-section">
      <h2>Escanear código QR del cliente</h2>
      <label for="cameraSelect">Elige cámara:</label>
      <select id="cameraSelect"></select>

      <div id="reader" style="width:300px; margin:auto; border:1px solid #ccc; border-radius:10px;"></div>
      <div id="scan-status" style="margin-top:10px; text-align:center; color:#666;"></div>
    </div>

    <div id="result" class="user-info" style="margin-top:20px;"></div>

    <!-- Asignar Nutrias y Canje -->
    <div class="form-section">
      <input type="number" id="amount" placeholder="Monto de compra (MXN)" />
      <button id="assignBtn">Asignar Nutrias</button>
      <button id="redeemBtn" style="display:none; background:#f4a261; color:white;">Canjear bebida (-100 nutrias)</button>
    </div>
  </div>

  <!-- Overlay de carga -->
  <div id="loadingOverlay">
    <img src="assets/otter.png" alt="Nutria girando">
    <p>Procesando, por favor espera...</p>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby3ZOGhDlhLmyI8nhrq5KVBkJye-Q_9c6k4x1giUEnapr9llWv4j-adzVVazGJqRdY6aA/exec";
    let scannedCode = null;
    const reader = new Html5Qrcode("reader");
    const redeemBtn = document.getElementById("redeemBtn");
    const loadingOverlay = document.getElementById("loadingOverlay");

    document.addEventListener("DOMContentLoaded", () => {
      initCameras();
      document.getElementById("assignBtn").addEventListener("click", assignNutrias);
    });

    /* ========== FUNCIONES AUXILIARES ========== */
    function showModal({ title, message, buttonText = "Cerrar", onClose = null }) {
      const modal = document.createElement("div");
      Object.assign(modal.style, {
        position: "fixed", top: 0, left: 0, width: "100%", height: "100%",
        background: "rgba(0,0,0,0.6)", display: "flex", alignItems: "center",
        justifyContent: "center", zIndex: 9999
      });
      modal.innerHTML = `
        <div style="background:#fff; padding:25px 35px; border-radius:12px; text-align:center; font-family:sans-serif; max-width:320px;">
          <h2 style="margin-bottom:10px;">${title}</h2>
          <p style="margin-bottom:20px;">${message}</p>
          <button id="closeModal" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer;">${buttonText}</button>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById("closeModal").addEventListener("click", () => {
        document.body.removeChild(modal);
        if (onClose) onClose();
      });
    }

    function showConfirm(message, onConfirm) {
      const modal = document.createElement("div");
      Object.assign(modal.style, {
        position: "fixed", top: 0, left: 0, width: "100%", height: "100%",
        background: "rgba(0,0,0,0.6)", display: "flex", alignItems: "center",
        justifyContent: "center", zIndex: 9999
      });
      modal.innerHTML = `
        <div style="background:#fff; padding:25px 35px; border-radius:12px; text-align:center; font-family:sans-serif; max-width:320px;">
          <p style="margin-bottom:20px;">${message}</p>
          <button id="confirmYes" style="padding:8px 18px; background:#28a745; color:white; border:none; border-radius:6px; margin-right:10px;">Sí</button>
          <button id="confirmNo" style="padding:8px 18px; background:#dc3545; color:white; border:none; border-radius:6px;">No</button>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById("confirmYes").addEventListener("click", () => {
        document.body.removeChild(modal);
        onConfirm(true);
      });
      document.getElementById("confirmNo").addEventListener("click", () => {
        document.body.removeChild(modal);
        onConfirm(false);
      });
    }

    function showLoading() {
      loadingOverlay.style.display = "flex";
    }

    function hideLoading() {
      loadingOverlay.style.display = "none";
    }

    /* ========== SCANNER ========== */
    function initCameras() {
  Html5Qrcode.getCameras().then(cameras => {
    const select = document.getElementById("cameraSelect");
    if (!cameras || cameras.length === 0) {
      document.getElementById("scan-status").innerText = "⚠️ No se detectó ninguna cámara.";
      return;
    }

    // Llenar el selector de cámaras
    cameras.forEach(cam => {
      const option = document.createElement("option");
      option.value = cam.id;
      option.text = cam.label || "Cámara sin nombre";
      select.appendChild(option);
    });

    // Buscar cámara trasera por nombre o palabra clave
    let backCamera = cameras.find(cam =>
      cam.label.toLowerCase().includes("back") ||
      cam.label.toLowerCase().includes("trasera") ||
      cam.label.toLowerCase().includes("environment")
    );

    // Si no hay trasera, usar la primera
    const defaultCameraId = backCamera ? backCamera.id : cameras[0].id;

    // Seleccionarla en el dropdown
    select.value = defaultCameraId;

    // Iniciar con la cámara trasera por defecto
    startScanner(defaultCameraId);

    // Cambiar manualmente si el usuario elige otra
    select.addEventListener("change", () => {
      reader.stop()
        .then(() => startScanner(select.value))
        .catch(err => console.error("Error al detener la cámara:", err));
    });
  }).catch(err => {
    document.getElementById("scan-status").innerText = "❌ Error al obtener cámaras: " + err;
  });
}


    function startScanner(cameraId) {
      reader.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        decodedText => onScanSuccess(decodedText),
        () => document.getElementById("scan-status").innerText = "Buscando QR..."
      ).catch(err => {
        document.getElementById("scan-status").innerText = "❌ Error al iniciar cámara: " + err;
      });
    }

    function onScanSuccess(decodedText) {
      if (decodedText && decodedText !== scannedCode) {
        scannedCode = decodedText;
        reader.pause(true);
        document.getElementById("scan-status").innerText = "✅ Código detectado: " + decodedText;
        fetchUser(decodedText);
      }
    }

    /* ========== USUARIO ========== */
    function fetchUser(code) {
      fetch(`${SCRIPT_URL}?action=getUserByCode&code=${encodeURIComponent(code)}`)
        .then(res => res.json())
        .then(user => {
          document.getElementById("result").innerHTML = `
            <h3>${user.name}</h3>
            <p>Teléfono: ${user.phone}</p>
            <p>Nutrias actuales: ${user.nutrias}</p>
            <p>Recompensa: ${user.rewards}</p>
          `;
          redeemBtn.style.display = Number(user.nutrias) >= 100 ? "inline-block" : "none";
        })
        .catch(() => {
          document.getElementById("result").innerHTML = "<p style='color:red;'>❌ Usuario no encontrado.</p>";
          redeemBtn.style.display = "none";
        });
    }

    /* ========== ASIGNAR NUTRIAS ========== */
    async function assignNutrias() {
      if (!scannedCode) return showModal({ title: "Error", message: "Escanea primero un código QR." });
      const amount = document.getElementById("amount").value;
      if (!amount) return showModal({ title: "Error", message: "Ingresa el monto de compra." });

      showLoading();
      try {
        const res = await fetch(`${SCRIPT_URL}?action=addNutrias&code=${scannedCode}&amount=${amount}`);
        const text = await res.text();
        hideLoading();
        showModal({
          title: "✅ Asignación exitosa",
          message: text,
          onClose: () => fetchUser(scannedCode)
        });
      } catch (err) {
        hideLoading();
        showModal({ title: "Error", message: "No se pudo asignar. Intenta de nuevo." });
      }
    }

    /* ========== CANJE DE BEBIDA ========== */
    redeemBtn.addEventListener("click", async () => {
      if (!scannedCode) return showModal({ title: "Error", message: "Escanea primero un código QR." });

      showConfirm("⚠️ Confirma que deseas canjear 100 nutrias para una bebida gratis.", (confirm1) => {
        if (!confirm1) return;

        showConfirm("⚠️ Esta acción restará 100 nutrias. ¿Estás seguro?", async (confirm2) => {
          if (!confirm2) return;

          showLoading();
          try {
            const res = await fetch(`${SCRIPT_URL}?action=redeemBeverage&code=${scannedCode}`);
            const text = await res.text();
            hideLoading();

            const ref = "REF-" + Math.random().toString(36).substring(2, 8).toUpperCase();
            showModal({
              title: "✅ Canjeo exitoso",
              message: `
                <p>Referencia para ticket:</p>
                <h1 style="font-size:2em; margin:10px 0;">${ref}</h1>
                <p>Apúntala manualmente en el ticket del cliente.</p>
              `,
              onClose: () => fetchUser(scannedCode)
            });
          } catch (err) {
            hideLoading();
            showModal({ title: "Error", message: "No se pudo realizar el canje. Intenta de nuevo." });
          }
        });
      });
    });
  </script>
</body>
</html>
