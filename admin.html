<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saint Latte — Panel Admin</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode-scanner.d.ts"></script>
</head>
<body>
  <div class="container">
    <h1>Panel Administrador</h1>

    <div class="scanner-section">
      <h2>Escanear código QR del cliente</h2>
      <div id="reader" style="width:300px; margin:auto; border:1px solid #ccc; border-radius:10px;"></div>
      <div id="scan-status" style="margin-top:10px; text-align:center; color:#666;"></div>
    </div>

    <div id="result" class="user-info" style="margin-top:20px;"></div>

    <div class="form-section">
      <input type="number" id="amount" placeholder="Monto de compra (MXN)" />
      <button id="assignBtn">Asignar Nutrias</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzsV1ltk19LskuUGG2Yw9nFBOa2cueIXz3PKrW6CPl4z6DL_P8uzpGawDQODZE7IJ7lmQ/exec"; // <-- Pega aquí tu URL del WebApp publicada
    let scannedCode = null;

    document.addEventListener("DOMContentLoaded", () => {
      startScanner();
      document.getElementById("assignBtn").addEventListener("click", assignNutrias);
    });

    function startScanner() {
      const reader = new Html5Qrcode("reader");

      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          const cameraId = devices[0].id;
          reader.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            (decodedText) => onScanSuccess(decodedText, reader),
            (errorMsg) => {
              document.getElementById("scan-status").innerText = "Buscando QR...";
            }
          ).catch(err => {
            document.getElementById("scan-status").innerText = "❌ Error al iniciar cámara: " + err;
          });
        } else {
          document.getElementById("scan-status").innerText = "⚠️ No se detectó ninguna cámara.";
        }
      }).catch(err => {
        document.getElementById("scan-status").innerText = "❌ Error al obtener cámaras: " + err;
      });
    }

    function onScanSuccess(decodedText, reader) {
      if (decodedText && decodedText !== scannedCode) {
        scannedCode = decodedText;
        reader.pause(true);
        document.getElementById("scan-status").innerText = "✅ Código detectado: " + decodedText;
        fetchUser(decodedText);
      }
    }

    function fetchUser(code) {
      fetch(`${SCRIPT_URL}?action=getUserByCode&code=${encodeURIComponent(code)}`)
        .then(res => res.json())
        .then(user => {
          document.getElementById("result").innerHTML = `
            <h3>${user.name}</h3>
            <p>Teléfono: ${user.phone}</p>
            <p>Nutrias actuales: ${user.nutrias}</p>
            <p>Recompensa: ${user.rewards}</p>
          `;
        })
        .catch(() => {
          document.getElementById("result").innerHTML = "<p style='color:red;'>❌ Usuario no encontrado.</p>";
        });
    }

    async function assignNutrias() {
      if (!scannedCode) return alert("Escanea primero un código QR.");
      const amount = document.getElementById("amount").value;
      if (!amount) return alert("Ingresa el monto de compra.");

      const res = await fetch(`${SCRIPT_URL}?action=addNutrias&code=${scannedCode}&amount=${amount}`);
      const text = await res.text();
      alert(text);
      location.reload(); // reinicia el lector tras asignar
    }
  </script>
</body>
</html>
