<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saint Latte — Panel Admin</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Panel Administrador</h1>

    <div class="scanner-section">
      <h2>Escanear código QR del cliente</h2>
      <label for="cameraSelect">Elige cámara:</label>
      <select id="cameraSelect"></select>

      <div id="reader" style="width:300px; margin:auto; border:1px solid #ccc; border-radius:10px;"></div>
      <div id="scan-status" style="margin-top:10px; text-align:center; color:#666;"></div>
    </div>

    <div id="result" class="user-info" style="margin-top:20px;"></div>

    <!-- Asignar Nutrias y Canje -->
    <div class="form-section">
      <input type="number" id="amount" placeholder="Monto de compra (MXN)" />
      <button id="assignBtn">Asignar Nutrias</button>
      <button id="redeemBtn" style="display:none; background:#f4a261; color:white;">Canjear bebida (-100 nutrias)</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby3ZOGhDlhLmyI8nhrq5KVBkJye-Q_9c6k4x1giUEnapr9llWv4j-adzVVazGJqRdY6aA/exec";
    let scannedCode = null;
    const reader = new Html5Qrcode("reader");
    const redeemBtn = document.getElementById("redeemBtn");

    document.addEventListener("DOMContentLoaded", () => {
      initCameras();
      document.getElementById("assignBtn").addEventListener("click", assignNutrias);
    });

    /* ========== UTILIDAD PARA MOSTRAR MODALES ========== */
    function showModal({ title, message, buttonText = "Cerrar", onClose = null }) {
      const modal = document.createElement("div");
      modal.style.position = "fixed";
      modal.style.top = "0";
      modal.style.left = "0";
      modal.style.width = "100%";
      modal.style.height = "100%";
      modal.style.background = "rgba(0,0,0,0.6)";
      modal.style.display = "flex";
      modal.style.alignItems = "center";
      modal.style.justifyContent = "center";
      modal.style.zIndex = "9999";

      modal.innerHTML = `
        <div style="background:#fff; padding:25px 35px; border-radius:12px; text-align:center; font-family:sans-serif; max-width:320px; box-shadow:0 5px 15px rgba(0,0,0,0.2);">
          <h2 style="margin-bottom:10px;">${title}</h2>
          <p style="margin-bottom:20px;">${message}</p>
          <button id="closeModal" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer;">${buttonText}</button>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById("closeModal").addEventListener("click", () => {
        document.body.removeChild(modal);
        if (onClose) onClose();
      });
    }

    function showConfirm(message, onConfirm) {
      const modal = document.createElement("div");
      modal.style.position = "fixed";
      modal.style.top = "0";
      modal.style.left = "0";
      modal.style.width = "100%";
      modal.style.height = "100%";
      modal.style.background = "rgba(0,0,0,0.6)";
      modal.style.display = "flex";
      modal.style.alignItems = "center";
      modal.style.justifyContent = "center";
      modal.style.zIndex = "9999";

      modal.innerHTML = `
        <div style="background:#fff; padding:25px 35px; border-radius:12px; text-align:center; font-family:sans-serif; max-width:320px;">
          <p style="margin-bottom:20px;">${message}</p>
          <button id="confirmYes" style="padding:8px 18px; background:#28a745; color:white; border:none; border-radius:6px; margin-right:10px;">Sí</button>
          <button id="confirmNo" style="padding:8px 18px; background:#dc3545; color:white; border:none; border-radius:6px;">No</button>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById("confirmYes").addEventListener("click", () => {
        document.body.removeChild(modal);
        onConfirm(true);
      });
      document.getElementById("confirmNo").addEventListener("click", () => {
        document.body.removeChild(modal);
        onConfirm(false);
      });
    }

    /* ========== CÁMARA Y ESCÁNER ========== */
    function initCameras() {
      Html5Qrcode.getCameras().then(cameras => {
        const select = document.getElementById("cameraSelect");
        if (!cameras || cameras.length === 0) {
          document.getElementById("scan-status").innerText = "⚠️ No se detectó ninguna cámara.";
          return;
        }

        cameras.forEach(cam => {
          const option = document.createElement("option");
          option.value = cam.id;
          option.text = cam.label;
          select.appendChild(option);
        });

        select.addEventListener("change", () => {
          reader.stop().then(() => startScanner(select.value))
          .catch(err => console.log("Error al detener la cámara:", err));
        });

        startScanner(cameras[0].id);
      }).catch(err => {
        document.getElementById("scan-status").innerText = "❌ Error al obtener cámaras: " + err;
      });
    }

    function startScanner(cameraId) {
      reader.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        decodedText => onScanSuccess(decodedText),
        () => document.getElementById("scan-status").innerText = "Buscando QR..."
      ).catch(err => {
        document.getElementById("scan-status").innerText = "❌ Error al iniciar cámara: " + err;
      });
    }

    function onScanSuccess(decodedText) {
      if (decodedText && decodedText !== scannedCode) {
        scannedCode = decodedText;
        reader.pause(true);
        document.getElementById("scan-status").innerText = "✅ Código detectado: " + decodedText;
        fetchUser(decodedText);
      }
    }

    /* ========== CONSULTAR USUARIO ========== */
    function fetchUser(code) {
      fetch(`${SCRIPT_URL}?action=getUserByCode&code=${encodeURIComponent(code)}`)
        .then(res => res.json())
        .then(user => {
          document.getElementById("result").innerHTML = `
            <h3>${user.name}</h3>
            <p>Teléfono: ${user.phone}</p>
            <p>Nutrias actuales: ${user.nutrias}</p>
            <p>Recompensa: ${user.rewards}</p>
          `;
          redeemBtn.style.display = Number(user.nutrias) >= 100 ? "inline-block" : "none";
        })
        .catch(() => {
          document.getElementById("result").innerHTML = "<p style='color:red;'>❌ Usuario no encontrado.</p>";
          redeemBtn.style.display = "none";
        });
    }

    /* ========== ASIGNAR NUTRIAS ========== */
    async function assignNutrias() {
      if (!scannedCode) return showModal({ title: "Error", message: "Escanea primero un código QR." });
      const amount = document.getElementById("amount").value;
      if (!amount) return showModal({ title: "Error", message: "Ingresa el monto de compra." });

      const res = await fetch(`${SCRIPT_URL}?action=addNutrias&code=${scannedCode}&amount=${amount}`);
      const text = await res.text();

      showModal({
        title: "✅ Asignación exitosa",
        message: text,
        onClose: () => fetchUser(scannedCode)
      });
    }

    /* ========== CANJE DE BEBIDA ========== */
    redeemBtn.addEventListener("click", async () => {
      if (!scannedCode) return showModal({ title: "Error", message: "Escanea primero un código QR." });

      showConfirm("⚠️ Confirma que deseas canjear 100 nutrias para una bebida gratis.", (confirm1) => {
        if (!confirm1) return;

        showConfirm("⚠️ Esta acción restará 100 nutrias. ¿Estás seguro?", async (confirm2) => {
          if (!confirm2) return;

          const res = await fetch(`${SCRIPT_URL}?action=redeemBeverage&code=${scannedCode}`);
          const text = await res.text();

          const ref = "REF-" + Math.random().toString(36).substring(2, 8).toUpperCase();

          showModal({
            title: "✅ Canjeo exitoso",
            message: `
              <p>Referencia para ticket:</p>
              <h1 style="font-size:2em; margin:10px 0;">${ref}</h1>
              <p>Apúntala manualmente en el ticket del cliente.</p>
            `,
            onClose: () => fetchUser(scannedCode)
          });
        });
      });
    });
  </script>
</body>
</html>
